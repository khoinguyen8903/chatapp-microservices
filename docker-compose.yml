version: '3.8'

services:
  # --- API GATEWAY ---
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      - auth-service
      - chat-service
      - media-service # Bổ sung phụ thuộc
    environment:
      JWT_SECRET: "mysecretkey123456789012345678901234"
      JWT_EXPIRATION_MS: 86400000

  # --- AUTH SERVICE ---
  auth-service:
    build: ./auth-service 
    container_name: auth-service
    ports:
      - "8081:8081" 
    networks:
      - app-network
    depends_on:
      - postgres-db
    environment:
      # Kết nối nội bộ Docker dùng tên service 'postgres-db'
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-db:5432/authdb?options=-c%20timezone=Asia/Ho_Chi_Minh
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      SERVER_PORT: 8081
      JWT_SECRET: "mysecretkey123456789012345678901234"
      JWT_EXPIRATION_MS: 86400000

  # --- AUTH DATABASE (Postgres - Port 5432) ---
  postgres-db:
    image: postgres:15
    container_name: postgres-db
    ports:
      - "5432:5432"
    networks:
      - app-network
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # --- MEDIA SERVICE (JAVA APP - MỚI BỔ SUNG) ---
  media-service:
    build: ./media-service
    container_name: media-service
    ports:
      - "8083:8083"
    networks:
      - app-network
    depends_on:
      - media-db
      - minio
    environment:
      SERVER_PORT: 8083
      # Cấu hình DB: Dùng tên container 'media-db' và cổng trong 5432
      SPRING_DATASOURCE_URL: jdbc:postgresql://media-db:5432/mediadb?options=-c%20timezone=Asia/Ho_Chi_Minh
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      
      # Cấu hình MinIO: Dùng tên container 'minio' và cổng 9000
      MINIO_URL: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: chatapp-files

  # --- MEDIA DATABASE (Postgres - Port 5434) ---
  media-db:
    image: postgres:15
    container_name: media-db
    ports:
      - "5434:5432" # Map cổng 5434 máy ngoài vào 5432 máy trong
    networks:
      - app-network
    environment:
      POSTGRES_DB: mediadb    
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      TZ: Asia/Ho_Chi_Minh # Sửa lỗi Timezone
    volumes:
      - media_data:/var/lib/postgresql/data

  # --- MINIO OBJECT STORAGE ---
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"  # Cổng API upload file
      - "9001:9001"  # Cổng giao diện quản lý (Console)
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    networks:
      - app-network
    volumes:
      - minio_data:/data

  # --- CHAT SERVICE ---
  chat-service:
    build: ./chat-service
    container_name: chat-service
    ports:
      - "8082:8082"
    networks:
      - app-network
    depends_on:
      - chat-mongo
    environment:
      SERVER_PORT: 8082
      SPRING_DATA_MONGODB_URI: mongodb://chat-mongo:27017/chatdb
      NOTIFICATION_SERVICE_URL: http://notification-service:8080

  # --- CHAT DATABASE (MongoDB) ---
  chat-mongo:
    image: mongo:6.0
    container_name: chat-mongo
    ports:
      - "27017:27017"
    networks:
      - app-network
    volumes:
      - chat_mongo_data:/data/db

  # --- FRONTEND (Angular) ---
  frontend:
    build: ./chat-client
    container_name: chat-frontend
    ports:
      - "3000:80"
    networks:
      - app-network
    depends_on:
      - api-gateway
  redis:
    image: redis:alpine
    container_name: chat-redis
    ports:
      - "6379:6379"
    networks:
      - app-network 
  notification-service:
    build: ./notification-service  # Tên thư mục chứa code của bạn
    container_name: notification-service
    ports:
      - "8084:8080" # Máy ngoài 8084 -> Docker 8080
    networks:
      - app-network
    depends_on:
      - redis # Phải đợi Redis chạy xong mới chạy cái này
    environment:
      SERVER_PORT: 8080
      # Cấu hình Redis (trỏ vào service 'redis' trong file này)
      SPRING_DATA_REDIS_HOST: redis 
      SPRING_DATA_REDIS_PORT: 6379
      # Firebase Config
      # Đảm bảo file serviceAccountKey.json đã được copy vào khi build Docker
      APP_FIREBASE_CONFIG: classpath:firebase-service-account.json

# --- NETWORKS & VOLUMES ---
networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  chat_mongo_data:
  media_data:
  minio_data: