version: '3.8'

services:
  # --- API GATEWAY ---
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      - auth-service
      - chat-service
      - media-service
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      JWT_SECRET: "mysecretkey123456789012345678901234"
      JWT_EXPIRATION_MS: 86400000
      JAVA_OPTS: "-Xms256m -Xmx400m"

  # --- AUTH SERVICE ---
  auth-service:
    build: ./auth-service 
    container_name: auth-service
    ports:
      - "8081:8081" 
    networks:
      - app-network
    depends_on:
      - postgres-db
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-db:5432/authdb?options=-c%20timezone=Asia/Ho_Chi_Minh
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      SERVER_PORT: 8081
      APP_VERIFICATION_URL: https://api.chatify.asia/api/auth/verify
      APP_FRONTEND_URL: https://chatify.asia
      JWT_SECRET: "mysecretkey123456789012345678901234"
      JWT_EXPIRATION_MS: 86400000
      # Email Configuration (Update with your Gmail credentials)
      MAIL_USERNAME: nguyenlepdp0809@gmail.com
      MAIL_PASSWORD: gwqc utct kimh bnin
      APP_BASE_URL: https://api.chatify.asia
      JAVA_OPTS: "-Xms384m -Xmx600m"

  # --- AUTH DATABASE ---
  postgres-db:
    image: postgres:15
    container_name: postgres-db
    ports:
      - "5432:5432"
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: ["postgres", "-c", "shared_buffers=128MB", "-c", "max_connections=100"]

  # --- MEDIA SERVICE ---
  media-service:
    build: ./media-service
    container_name: media-service
    ports:
      - "8083:8083"
    networks:
      - app-network
    depends_on:
      - media-db
      - minio
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    environment:
      SERVER_PORT: 8083
      SPRING_DATASOURCE_URL: jdbc:postgresql://media-db:5432/mediadb?options=-c%20timezone=Asia/Ho_Chi_Minh
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      MINIO_URL: http://minio:9000
      MINIO_PUBLIC_URL: https://api.chatify.asia
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: chatapp-files
      JAVA_OPTS: "-Xms384m -Xmx600m"

  # --- MEDIA DATABASE ---
  media-db:
    image: postgres:15
    container_name: media-db
    ports:
      - "5434:5432"
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      POSTGRES_DB: mediadb     
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - media_data:/var/lib/postgresql/data
    command: ["postgres", "-c", "shared_buffers=128MB", "-c", "max_connections=100"]

  # --- MINIO ---
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    networks:
      - app-network
    volumes:
      - minio_data:/data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # --- CHAT SERVICE ---
  chat-service:
    build: ./chat-service
    container_name: chat-service
    ports:
      - "8082:8082"
    networks:
      - app-network
    depends_on:
      - chat-mongo
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    environment:
      SERVER_PORT: 8082
      SPRING_DATA_MONGODB_URI: mongodb://chat-mongo:27017/chatdb
      NOTIFICATION_SERVICE_URL: http://notification-service:8080
      JAVA_OPTS: "-Xms384m -Xmx600m"

  # --- CHAT DATABASE ---
  chat-mongo:
    image: mongo:6.0
    container_name: chat-mongo
    ports:
      - "27017:27017"
    networks:
      - app-network
    volumes:
      - chat_mongo_data:/data/db
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    command: ["mongod", "--wiredTigerCacheSizeGB", "0.3"]

  # --- FRONTEND ---
  frontend:
    build: ./chat-client
    container_name: chat-frontend
    ports:
      - "3000:80"
    networks:
      - app-network
    depends_on:
      - api-gateway
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # --- REDIS ---
  redis:
    image: redis:alpine
    container_name: chat-redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    command: ["redis-server", "--maxmemory", "128mb", "--maxmemory-policy", "allkeys-lru"] 

  # --- NOTIFICATION SERVICE ---
  notification-service:
    build: ./notification-service 
    container_name: notification-service
    ports:
      - "8084:8080"
    networks:
      - app-network
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    environment:
      SERVER_PORT: 8080
      SPRING_DATA_REDIS_HOST: redis 
      SPRING_DATA_REDIS_PORT: 6379
      APP_FIREBASE_CONFIG: classpath:firebase-service-account.json
      JAVA_OPTS: "-Xms256m -Xmx400m"

  # --- CLOUDFLARE TUNNEL (ĐÃ THÊM MỚI) ---
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel run
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    environment:
      # Token đã được thêm vào đây
      TUNNEL_TOKEN: "eyJhIjoiNTdhODE2YjBhN2Y1ZjY2NTZjOTBhZTdiYTYwM2U3ZDUiLCJ0IjoiZTg5YzkwOWItYWQ5Mi00YzA3LWJkZWUtMGI1NmMyMjU0MGY0IiwicyI6Ik5qWXdPRFE0TURjdE9EVXhaQzAwTTJOaUxUZzVOV1F0WXpSa1pUQmlNemxoWkRRMSJ9"

# --- NETWORKS & VOLUMES ---
networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  chat_mongo_data:
  media_data:
  minio_data: