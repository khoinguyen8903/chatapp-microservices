<!-- Nuclear Flex Layout - Native App-like Sticky Layout -->
<div class="chat-layout-container">

  <!-- HEADER: Fixed height, never shrinks -->
  <header class="chat-header">
    @if (facade.selectedSession(); as session) {
      <div class="header-wrapper">
        <!-- Mobile Back Button -->
        <button
          (click)="onBackToSidebar?.()"
          class="back-button"
          aria-label="Back to conversations">
          <i class="fas fa-arrow-left"></i>
        </button>

        <!-- User/Group Info -->
        <div class="header-profile animate-fade-in">
          <div class="profile-avatar-wrapper">
            <div 
              class="profile-avatar"
              [class.group-avatar]="session.type === 'GROUP'"
              [class.private-avatar]="session.type === 'PRIVATE'">
              
              <img
                [src]="session.avatar"
                (error)="onAvatarError($event)"
                [alt]="session.name + ' avatar'"
                class="avatar-img"
                loading="lazy"
              >
            </div>

            @if (session.type === 'PRIVATE') {
              <span 
                class="status-indicator"
                [class.online]="facade.partnerStatus() === 'ONLINE'"
                [class.offline]="facade.partnerStatus() === 'OFFLINE'"
                [title]="facade.partnerStatus() === 'ONLINE' ? 'Online' : 'Offline'">
              </span>
            }
          </div>

          <div class="profile-info">
            <h2 class="profile-name text-truncate">
              {{ session.name }}
            </h2>

            <div class="profile-status">
              @if (session.type === 'GROUP') {
                <i class="fas fa-user-friends"></i>
                <span>{{ session.memberCount || 0 }} members</span>
              } @else {
                @if (facade.partnerStatus() === 'ONLINE') {
                  <span class="online-pulse"></span>
                  <span class="status-text">Active now</span>
                } @else {
                  <span class="status-text">{{ facade.lastSeen() | lastSeen:facade.partnerStatus() }}</span>
                }
              }
            </div>
          </div>
        </div>

        <!-- Header Actions -->
        <div class="header-actions">
          <button 
            (click)="facade.startVoiceCall()"
            class="action-button"
            title="Voice Call"
            aria-label="Start voice call">
            <i class="fas fa-phone-alt"></i>
          </button>
          
          <button 
            (click)="facade.startVideoCall()"
            class="action-button"
            title="Video Call"
            aria-label="Start video call">
            <i class="fas fa-video"></i>
          </button>
          
          <button 
            class="action-button"
            title="More Options"
            aria-label="More options">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </div>

    } @else {
      <!-- No Chat Selected State -->
      <div class="no-chat-selected">
        <span class="status-dot"></span>
        <span class="status-text">No conversation selected</span>
      </div>
    }
  </header>

  <!-- MESSAGES: Grows to fill space, scrolls internally -->
  <section
    class="messages-viewport custom-scrollbar"
    #scrollContainer
    role="log"
    aria-live="polite"
    aria-label="Chat messages">
    <div
      id="chat-container"
      class="messages-area">
    
    @if (!facade.selectedSession()) {
      <!-- Welcome Screen (No Chat Selected) -->
      <div class="welcome-screen animate-fade-in">
        <div class="welcome-icon">
          <i class="fas fa-paper-plane"></i>
        </div>
        <h3 class="welcome-title">Welcome to Messages!</h3>
        <p class="welcome-subtitle">Select a conversation to start chatting</p>
      </div>
    }

    <!-- Message List -->
    <div class="message-list">
      @for (msg of facade.messages(); track trackByMessageId($index, msg)) {
        <article 
          class="message-wrapper"
          [class.sent]="msg.senderId === facade.currentUser().id"
          [class.received]="msg.senderId !== facade.currentUser().id">
          
          <div class="message-content-wrapper">
            <!-- Group sender name -->
            @if (facade.selectedSession()?.type === 'GROUP' && msg.senderId !== facade.currentUser().id) {
              <span class="sender-name">
                {{ msg.senderName || 'Member' }}
              </span>
            }

            <!-- Message Bubble with Glassmorphism -->
            <div 
              class="message-bubble"
              [class.bubble-sent]="msg.senderId === facade.currentUser().id"
              [class.bubble-received]="msg.senderId !== facade.currentUser().id">
              
              <!-- Image Message -->
              @if (msg.type === MessageType.IMAGE) {
                <div class="attachment-image">
                  <img 
                    [src]="msg.content | safeUrl" 
                    alt="Shared image"
                    loading="lazy">
                </div>
              }
              
              <!-- Video Message -->
              @else if (msg.type === MessageType.VIDEO) {
                <div class="attachment-video">
                  <video controls>
                    <source [src]="msg.content | safeUrl">
                  </video>
                </div>
              }
              
              <!-- File Message -->
              @else if (msg.type === MessageType.FILE) {
                <a 
                  [href]="msg.content | safeUrl" 
                  target="_blank" 
                  class="attachment-file"
                  [class.file-sent]="msg.senderId === facade.currentUser().id"
                  [class.file-received]="msg.senderId !== facade.currentUser().id">
                  
                  <div class="file-icon">
                    <i class="fas fa-file-lines"></i>
                  </div>
                  
                  <div class="file-details">
                    <p class="file-name text-truncate">
                      {{ msg.fileName || (msg.content | fileName) }}
                    </p>
                    <span class="file-action">Download</span>
                  </div>
                </a>
              }
              
              <!-- Text Message -->
              @else {
                <p class="message-text">{{ msg.content }}</p>
              }
            </div>

            <!-- Message Metadata (Timestamp + Status) -->
            <div class="message-meta">
              <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
              
              @if (msg.senderId === facade.currentUser().id) {
                @if (msg.status === MessageStatus.SEEN) {
                  <i class="fas fa-check-double status-icon seen" title="Seen"></i>
                } @else if (msg.status === MessageStatus.DELIVERED) {
                  <i class="fas fa-check-double status-icon delivered" title="Delivered"></i>
                } @else {
                  <i class="fas fa-check status-icon sent" title="Sent"></i>
                }
              }
            </div>
          </div>
        </article>
      }

      <!-- Typing Indicator -->
      @if (facade.isRecipientTyping()) {
        <div class="typing-indicator-wrapper animate-slide-up">
          <div class="typing-bubble">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      }
    </div>
    </div>
  </section>

  <!-- INPUT: Fixed height, never shrinks -->
  <footer class="chat-input-area">
    <div class="input-wrapper">
      <!-- Hidden File Input -->
      <input 
        type="file" 
        #fileInput 
        (change)="onFileSelected($event)" 
        class="file-input-hidden"
        aria-label="Upload file">

      <!-- Attachment Button -->
      <button
        (click)="fileInput.click()"
        [disabled]="!facade.selectedSession()"
        class="attachment-button"
        title="Attach file"
        aria-label="Attach file">
        <i class="fas fa-paperclip"></i>
      </button>

      <!-- Message Textarea -->
      <textarea
        [(ngModel)]="newMessage"
        (keyup.enter)="sendMessage()"
        (input)="onInputTyping()"
        placeholder="Type a message..."
        rows="1"
        class="message-input"
        [disabled]="!facade.selectedSession()"
        aria-label="Message input">
      </textarea>

      <!-- Send Button -->
      <button
        (click)="sendMessage()"
        [disabled]="!newMessage.trim() || !facade.selectedSession()"
        class="send-button"
        title="Send message"
        aria-label="Send message">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </footer>

</div>