<!-- Nuclear Flex Layout - Native App-like Sticky Layout -->
<div class="chat-layout-container">

  <!-- HEADER: Fixed height, never shrinks -->
  <header class="chat-header">
    @if (facade.selectedSession(); as session) {
      <div class="header-wrapper">
        <!-- Mobile Back Button -->
        <button
          (click)="onBackToSidebar?.()"
          class="back-button"
          aria-label="Back to conversations">
          <i class="fas fa-arrow-left"></i>
        </button>

        <!-- User/Group Info -->
        <div class="header-profile animate-fade-in">
          <div class="profile-avatar-wrapper">
            <div 
              class="profile-avatar"
              [class.group-avatar]="session.type === 'GROUP'"
              [class.private-avatar]="session.type === 'PRIVATE'">
              
              <img
                [src]="session.avatar"
                (error)="onAvatarError($event)"
                [alt]="session.name + ' avatar'"
                class="avatar-img"
                loading="lazy"
              >
            </div>

            @if (session.type === 'PRIVATE') {
              <span 
                class="status-indicator"
                [class.online]="facade.partnerStatus() === 'ONLINE'"
                [class.offline]="facade.partnerStatus() === 'OFFLINE'"
                [title]="facade.partnerStatus() === 'ONLINE' ? 'Online' : 'Offline'">
              </span>
            }
          </div>

          <div class="profile-info">
            <h2 class="profile-name text-truncate">
              {{ session.name }}
            </h2>

            <div class="profile-status">
              @if (session.type === 'GROUP') {
                <i class="fas fa-user-friends"></i>
                <span>{{ session.memberCount || 0 }} members</span>
              } @else {
                @if (facade.partnerStatus() === 'ONLINE') {
                  <span class="online-pulse"></span>
                  <span class="status-text">Active now</span>
                } @else {
                  <span class="status-text">{{ facade.lastSeen() | lastSeen:facade.partnerStatus() }}</span>
                }
              }
            </div>
          </div>
        </div>

        <!-- Header Actions -->
        <div class="header-actions">
          <button 
            (click)="facade.startVoiceCall()"
            class="action-button"
            title="Voice Call"
            aria-label="Start voice call">
            <i class="fas fa-phone-alt"></i>
          </button>
          
          <button 
            (click)="facade.startVideoCall()"
            class="action-button"
            title="Video Call"
            aria-label="Start video call">
            <i class="fas fa-video"></i>
          </button>
          
          <button 
            (click)="toggleRightSidebar()"
            class="action-button"
            [class.active]="showRightSidebar"
            title="Chat Details"
            aria-label="Toggle chat details">
            <i class="fas fa-info-circle"></i>
          </button>
        </div>
      </div>

    } @else {
      <!-- No Chat Selected State -->
      <div class="no-chat-selected">
        <span class="status-dot"></span>
        <span class="status-text">No conversation selected</span>
      </div>
    }
  </header>

  <!-- MESSAGES: Grows to fill space, scrolls internally -->
  <section
    class="messages-viewport custom-scrollbar"
    #scrollContainer
    (click)="closeAllReactions()"
    role="log"
    aria-live="polite"
    aria-label="Chat messages">
    <div
      id="chat-container"
      class="messages-area">
    
    @if (!facade.selectedSession()) {
      <!-- Welcome Screen (No Chat Selected) -->
      <div class="welcome-screen animate-fade-in">
        <div class="welcome-icon">
          <i class="fas fa-paper-plane"></i>
        </div>
        <h3 class="welcome-title">Welcome to Messages!</h3>
        <p class="welcome-subtitle">Select a conversation to start chatting</p>
      </div>
    }

    <!-- Message List -->
    <div class="message-list">
      @for (msg of facade.messages(); track trackByMessageId($index, msg)) {
        <article 
          class="message-wrapper"
          [class.sent]="msg.senderId === facade.currentUser().id"
          [class.received]="msg.senderId !== facade.currentUser().id"
          (contextmenu)="onRightClick($event, msg)"
          (click)="onMobileMessageClick($event, msg)"
          (mouseenter)="onMouseEnter(msg)"
          (mouseleave)="onMouseLeave(msg)">
          
          <div class="message-content-wrapper">
            <!-- Group sender name -->
            @if (facade.selectedSession()?.type === 'GROUP' && msg.senderId !== facade.currentUser().id) {
              <span class="sender-name">
                {{ msg.senderName || 'Member' }}
              </span>
            }

            <!-- Message Bubble with Glassmorphism -->
            <div 
              class="message-bubble"
              [class.bubble-sent]="msg.senderId === facade.currentUser().id"
              [class.bubble-received]="msg.senderId !== facade.currentUser().id"
              [class.has-reactions]="msg.reactions && msg.reactions.length > 0"
              [class.revoked]="msg.messageStatus === 'REVOKED'"
              [class.show-status]="msg.showStatus"
              (touchstart)="onTouchStart($event, msg)"
              (touchend)="onTouchEnd($event, msg)"
              (touchmove)="onTouchMove($event, msg)"
              (touchcancel)="onTouchCancel(msg)"
              (contextmenu)="$event.preventDefault()">

              <!-- [NEW] Inline Action Buttons -->
              @if (shouldShowActions(msg)) {
                <div 
                  class="message-actions"
                  [class.actions-sent]="msg.senderId === facade.currentUser().id"
                  [class.actions-received]="msg.senderId !== facade.currentUser().id"
                  (click)="$event.stopPropagation()">
                  
                  <!-- Emoji/Reaction Button -->
                  <button 
                    class="action-btn emoji-btn"
                    (click)="openQuickReaction($event, msg)"
                    type="button"
                    title="React">
                    <i class="far fa-smile"></i>
                  </button>

                  <!-- Reply Button -->
                  <button 
                    class="action-btn reply-btn"
                    (click)="handleReply(msg); hoveredMessageId = null; longPressMessageId = null"
                    type="button"
                    title="Reply">
                    <i class="fas fa-reply"></i>
                  </button>

                  <!-- More Options Button (Three Dots) -->
                  <button 
                    class="action-btn more-btn"
                    (click)="openMoreOptions($event, msg)"
                    type="button"
                    title="More options">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                </div>
              }

              <!-- Reaction Bar (Emoji Picker) -->
              @if (msg.showReactionBar && msg.messageStatus !== 'REVOKED') {
                <div class="reaction-bar" (click)="$event.stopPropagation()">
                  <button class="reaction-item" (click)="onReact(msg, '‚ù§Ô∏è')" type="button">‚ù§Ô∏è</button>
                  <button class="reaction-item" (click)="onReact(msg, 'üòÜ')" type="button">üòÜ</button>
                  <button class="reaction-item" (click)="onReact(msg, 'üòÆ')" type="button">üòÆ</button>
                  <button class="reaction-item" (click)="onReact(msg, 'üò¢')" type="button">üò¢</button>
                  <button class="reaction-item" (click)="onReact(msg, 'üëç')" type="button">üëç</button>
                </div>
              }

              <!-- [NEW] Revoked Message Display -->
              @if (msg.messageStatus === 'REVOKED') {
                <div class="revoked-content">
                  <i class="fas fa-ban"></i>
                  <span class="revoked-text">Tin nh·∫Øn ƒë√£ b·ªã thu h·ªìi</span>
                </div>
              }

              <!-- [NEW] Reply Quote (if this message is a reply) -->
              @if (msg.replyToId && msg.messageStatus !== 'REVOKED' && msg.replyToMessage) {
                <div class="reply-quote">
                  <div class="reply-quote-bar"></div>
                  <div class="reply-quote-content">
                    <!-- Show sender name if in group chat -->
                    @if (facade.selectedSession()?.type === 'GROUP') {
                      <span class="reply-sender">{{ msg.replyToMessage.senderName || 'Someone' }}</span>
                    }
                    
                    <!-- Show replied-to message content based on type -->
                    @if (msg.replyToMessage.type === MessageType.TEXT) {
                      <span class="reply-quote-text">{{ msg.replyToMessage.content }}</span>
                    } @else if (msg.replyToMessage.type === MessageType.IMAGE) {
                      <span class="reply-quote-text">
                        <i class="fas fa-image"></i> Photo
                      </span>
                    } @else if (msg.replyToMessage.type === MessageType.VIDEO) {
                      <span class="reply-quote-text">
                        <i class="fas fa-video"></i> Video
                      </span>
                    } @else if (msg.replyToMessage.type === MessageType.AUDIO) {
                      <span class="reply-quote-text">
                        <i class="fas fa-microphone"></i> Voice message
                      </span>
                    } @else if (msg.replyToMessage.type === MessageType.FILE) {
                      <span class="reply-quote-text">
                        <i class="fas fa-file"></i> {{ msg.replyToMessage.fileName || 'File' }}
                      </span>
                    }
                  </div>
                </div>
              }
              
              <!-- Message Content (only if not revoked) -->
              @if (msg.messageStatus !== 'REVOKED') {
                <!-- Image Message -->
              @if (msg.type === MessageType.IMAGE) {
                <div class="attachment-image">
                  <img 
                    [src]="msg.content | safeUrl" 
                    alt="Shared image"
                    loading="lazy">
                </div>
              }
              
              <!-- Video Message -->
              @else if (msg.type === MessageType.VIDEO) {
                <div class="attachment-video">
                  <video controls>
                    <source [src]="msg.content | safeUrl">
                  </video>
                </div>
              }

              <!-- Audio Message -->
              @else if (msg.type === MessageType.AUDIO) {
                <div class="attachment-audio">
                  <!-- Hidden native audio element (controls removed for UI consistency) -->
                  <audio
                    #audioRef
                    class="native-audio"
                    preload="metadata"
                    [src]="msg.content | safeUrl"
                    (loadedmetadata)="onAudioLoadedMetadata(msg, audioRef)"
                    (durationchange)="onAudioLoadedMetadata(msg, audioRef)"
                    (ended)="onAudioEnded(msg)">
                  </audio>

                  <!-- Custom Messenger-like audio player -->
                  <div class="audio-player" role="group" aria-label="Voice message player">
                    <button
                      type="button"
                      class="audio-play"
                      [attr.aria-label]="msg.isPlaying ? 'Pause voice message' : 'Play voice message'"
                      (click)="toggleAudio(msg, audioRef)">
                      @if (msg.isPlaying) {
                        <i class="fas fa-pause"></i>
                      } @else {
                        <i class="fas fa-play"></i>
                      }
                    </button>

                    <div class="audio-waveform" aria-hidden="true">
                      <!-- Static waveform placeholder SVG (replace with real waveform later) -->
                      <svg viewBox="0 0 220 24" preserveAspectRatio="none">
                        <rect x="2" y="10" width="4" height="8" rx="2"></rect>
                        <rect x="10" y="6" width="4" height="16" rx="2"></rect>
                        <rect x="18" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="26" y="4" width="4" height="18" rx="2"></rect>
                        <rect x="34" y="9" width="4" height="10" rx="2"></rect>
                        <rect x="42" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="50" y="7" width="4" height="14" rx="2"></rect>
                        <rect x="58" y="11" width="4" height="8" rx="2"></rect>
                        <rect x="66" y="5" width="4" height="18" rx="2"></rect>
                        <rect x="74" y="10" width="4" height="8" rx="2"></rect>
                        <rect x="82" y="6" width="4" height="16" rx="2"></rect>
                        <rect x="90" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="98" y="4" width="4" height="18" rx="2"></rect>
                        <rect x="106" y="9" width="4" height="10" rx="2"></rect>
                        <rect x="114" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="122" y="7" width="4" height="14" rx="2"></rect>
                        <rect x="130" y="11" width="4" height="8" rx="2"></rect>
                        <rect x="138" y="5" width="4" height="18" rx="2"></rect>
                        <rect x="146" y="10" width="4" height="8" rx="2"></rect>
                        <rect x="154" y="6" width="4" height="16" rx="2"></rect>
                        <rect x="162" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="170" y="4" width="4" height="18" rx="2"></rect>
                        <rect x="178" y="9" width="4" height="10" rx="2"></rect>
                        <rect x="186" y="12" width="4" height="6" rx="2"></rect>
                        <rect x="194" y="7" width="4" height="14" rx="2"></rect>
                        <rect x="202" y="11" width="4" height="8" rx="2"></rect>
                        <rect x="210" y="10" width="4" height="8" rx="2"></rect>
                      </svg>
                    </div>

                    <span class="audio-duration">{{ getAudioDurationLabel(msg) }}</span>
                  </div>
                </div>
              }
              
              <!-- File Message -->
              @else if (msg.type === MessageType.FILE) {
                <a 
                  [href]="msg.content | safeUrl" 
                  target="_blank" 
                  class="attachment-file"
                  [class.file-sent]="msg.senderId === facade.currentUser().id"
                  [class.file-received]="msg.senderId !== facade.currentUser().id">
                  
                  <div class="file-icon">
                    <i class="fas fa-file-lines"></i>
                  </div>
                  
                  <div class="file-details">
                    <p class="file-name text-truncate">
                      {{ msg.fileName || (msg.content | fileName) }}
                    </p>
                    <span class="file-action">Download</span>
                  </div>
                </a>
              }
              
              <!-- Text Message -->
              @else {
                <p class="message-text">{{ msg.content }}</p>
              }
              } <!-- End of: if not revoked -->

              <!-- Reactions Display (pill, slightly outside bubble) -->
              @if (msg.reactions && msg.reactions.length > 0) {
                <div class="reactions-display">
                  <div class="reaction-icons">
                    @for (icon of getReactionIcons(msg.reactions); track $index) {
                      <span class="reaction-icon">{{ icon }}</span>
                    }
                  </div>
                  <span class="reaction-total">{{ getReactionTotal(msg.reactions) }}</span>
                </div>
              }
            </div>

            <!-- Message Metadata (Timestamp + Status) - Shows on hover (desktop) or tap (mobile) -->
            <div class="message-meta" [class.show-status]="msg.showStatus">
              <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
              
              @if (msg.senderId === facade.currentUser().id) {
                @if (msg.status === MessageStatus.SEEN) {
                  <i class="fas fa-check-double status-icon seen" title="Seen"></i>
                  <span class="status-label">ƒê√£ xem</span>
                } @else if (msg.status === MessageStatus.DELIVERED) {
                  <i class="fas fa-check-double status-icon delivered" title="Delivered"></i>
                  <span class="status-label">ƒê√£ nh·∫≠n</span>
                } @else {
                  <i class="fas fa-check status-icon sent" title="Sent"></i>
                  <span class="status-label">ƒê√£ g·ª≠i</span>
                }
              }
            </div>
          </div>
        </article>
      }

      <!-- Typing Indicator -->
      @if (facade.isRecipientTyping()) {
        <div class="typing-indicator-wrapper animate-slide-up">
          <div class="typing-bubble">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      }
    </div>
    </div>
  </section>

  <!-- INPUT: Fixed height, never shrinks -->
  <footer class="chat-input-area">
    <!-- [NEW] Reply Banner -->
    @if (replyingToMsg) {
      <div class="reply-banner">
        <div class="reply-banner-content">
          <div class="reply-label">ƒêang tr·∫£ l·ªùi:</div>
          <div class="reply-preview">{{ getReplyPreview(replyingToMsg) }}</div>
        </div>
        <button 
          (click)="cancelReply()" 
          class="reply-cancel-btn"
          type="button"
          aria-label="Cancel reply">
          <i class="fas fa-times"></i>
        </button>
      </div>
    }

    <div class="input-wrapper">
      @if (showEmojiPicker && !isRecording) {
        <div class="emoji-picker-popover">
          <emoji-mart
            [isNative]="true"
            [set]="'apple'"
            (emojiClick)="onEmojiClick($event)">
          </emoji-mart>
        </div>
      }

      <!-- Hidden File Input -->
      <input 
        type="file" 
        #fileInput 
        (change)="onFileSelected($event)" 
        class="file-input-hidden"
        aria-label="Upload file">

      <!-- Attachment Button -->
      <button
        (click)="fileInput.click()"
        [disabled]="!facade.selectedSession() || isRecording"
        class="attachment-button"
        title="Attach file"
        aria-label="Attach file">
        <i class="fas fa-paperclip"></i>
      </button>

      @if (!isRecording) {
        <!-- Emoji Button -->
        <button
          (click)="toggleEmojiPicker()"
          [disabled]="!facade.selectedSession()"
          class="emoji-button"
          title="Emoji"
          aria-label="Open emoji picker">
          <i class="far fa-smile"></i>
        </button>

        <!-- Message Textarea -->
        <textarea
          [(ngModel)]="newMessage"
          (keyup.enter)="sendMessage()"
          (input)="onInputTyping()"
          placeholder="Type a message..."
          rows="1"
          class="message-input"
          [disabled]="!facade.selectedSession()"
          aria-label="Message input">
        </textarea>

        <!-- Microphone Button -->
        <button
          (click)="startRecording()"
          [disabled]="!facade.selectedSession()"
          class="mic-button"
          title="Record voice message"
          aria-label="Record voice message"
          type="button">
          <i class="fas fa-microphone"></i>
        </button>

        <!-- Send Button -->
        <button
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || !facade.selectedSession()"
          class="send-button"
          title="Send message"
          aria-label="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      } @else {
        <!-- Recording UI -->
        <div class="recording-bar" role="group" aria-label="Voice recording controls">
          <button
            (click)="cancelRecording()"
            class="recording-cancel"
            type="button"
            title="Cancel recording"
            aria-label="Cancel recording">
            <i class="fas fa-trash"></i>
          </button>

          <div class="recording-center" aria-label="Recording timer">
            <span class="recording-dot" aria-hidden="true"></span>
            <span class="recording-time">{{ recordingTime }}</span>
          </div>

          <button
            (click)="onSendRecording()"
            class="recording-send"
            type="button"
            title="Send recording"
            aria-label="Send recording">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      }
    </div>
  </footer>

  <!-- [NEW] Context Menu Overlay -->
  @if (contextMenuVisible && contextMenuMsg) {
    <div class="menu-backdrop" (click)="closeContextMenu()"></div>
    <ul 
      class="context-menu"
      [ngStyle]="menuStyle"
      (click)="$event.stopPropagation()">
      
      <!-- Reply Option (Always visible) -->
      <li (click)="handleReply(contextMenuMsg)" class="context-menu-item">
        <i class="fas fa-reply"></i>
        <span>Tr·∫£ l·ªùi</span>
      </li>
      
      <!-- Copy Option (Only for text messages) -->
      @if (isTextMessage(contextMenuMsg)) {
        <li (click)="handleCopy(contextMenuMsg)" class="context-menu-item">
          <i class="fas fa-copy"></i>
          <span>Sao ch√©p</span>
        </li>
      }
      
      <!-- Revoke Option (Only for own messages that aren't revoked) -->
      @if (canRevokeMessage(contextMenuMsg)) {
        <li (click)="handleRevoke(contextMenuMsg)" class="context-menu-item revoke">
          <i class="fas fa-undo"></i>
          <span>Thu h·ªìi</span>
        </li>
      }
      
      <!-- Delete For Me Option (Always visible) -->
      <li (click)="handleDeleteForMe(contextMenuMsg)" class="context-menu-item delete">
        <i class="fas fa-trash"></i>
        <span>X√≥a</span>
      </li>
    </ul>
  }

</div>

<!-- RIGHT SIDEBAR (Chat Details) - Facebook Messenger Style -->
@if (showRightSidebar) {
  <div class="right-sidebar-backdrop" (click)="closeRightSidebar()"></div>
}
<aside 
  class="right-sidebar"
  [class.is-open]="showRightSidebar"
  [class.is-closed]="!showRightSidebar">
  
  @if (facade.selectedSession(); as session) {
    <!-- Close Button (Mobile) -->
    <button class="sidebar-close-btn" (click)="closeRightSidebar()" aria-label="Close sidebar">
      <i class="fas fa-times"></i>
    </button>

    <!-- ========== PRIVATE CHAT: Partner Info ========== -->
    @if (session.type === 'PRIVATE') {
      <div class="sidebar-profile">
        <div class="profile-avatar-large">
          <img 
            [src]="session.avatar" 
            (error)="onAvatarError($event)"
            [alt]="session.name + ' avatar'"
            loading="lazy">
        </div>
        <h3 class="profile-name">{{ session.name }}</h3>
        <p class="profile-status-text">
          @if (facade.partnerStatus() === 'ONLINE') {
            <span class="status-online-dot"></span>
            ƒêang ho·∫°t ƒë·ªông
          } @else {
            {{ facade.lastSeen() | lastSeen:facade.partnerStatus() }}
          }
        </p>

        <!-- Action Buttons Row for Private Chat -->
        <div class="profile-actions">
          <a 
            class="profile-action-btn" 
            [routerLink]="['/profile', session.id]"
            title="Xem h·ªì s∆°">
            <i class="fas fa-user"></i>
            <span>Xem h·ªì s∆°</span>
          </a>
          <button 
            class="profile-action-btn" 
            [class.muted]="isMuted"
            (click)="toggleMute()"
            title="Mute">
            <i class="fas" [class.fa-bell]="!isMuted" [class.fa-bell-slash]="isMuted"></i>
            <span>{{ isMuted ? 'B·∫≠t' : 'T·∫Øt' }}</span>
          </button>
          <button 
            class="profile-action-btn" 
            (click)="openSearchInChat()"
            title="Search">
            <i class="fas fa-search"></i>
            <span>T√¨m ki·∫øm</span>
          </button>
        </div>
      </div>
    }

    <!-- ========== GROUP CHAT: Group Info & Members ========== -->
    @if (session.type === 'GROUP') {
      <div class="sidebar-profile group-profile">
        <div class="profile-avatar-large group-avatar-placeholder">
          <i class="fas fa-users"></i>
        </div>
        <h3 class="profile-name">{{ session.name }}</h3>
        <p class="profile-status-text">
          <i class="fas fa-user-friends"></i>
          {{ session.memberCount || 0 }} th√†nh vi√™n
        </p>

        <!-- Action Buttons Row for Group Chat -->
        <div class="profile-actions">
          <button 
            class="profile-action-btn"
            [class.active]="showGroupMembers"
            (click)="toggleGroupMembers()"
            title="Xem th√†nh vi√™n">
            <i class="fas fa-users-cog"></i>
            <span>{{ showGroupMembers ? '·∫®n' : 'Th√†nh vi√™n' }}</span>
          </button>
          <button 
            class="profile-action-btn" 
            [class.muted]="isMuted"
            (click)="toggleMute()"
            title="Mute">
            <i class="fas" [class.fa-bell]="!isMuted" [class.fa-bell-slash]="isMuted"></i>
            <span>{{ isMuted ? 'B·∫≠t' : 'T·∫Øt' }}</span>
          </button>
          <button 
            class="profile-action-btn" 
            (click)="openSearchInChat()"
            title="Search">
            <i class="fas fa-search"></i>
            <span>T√¨m ki·∫øm</span>
          </button>
        </div>

        <!-- Group Members List -->
        @if (showGroupMembers) {
          <div class="group-members-list">
            <h4 class="members-title">Th√†nh vi√™n nh√≥m</h4>
            
            @if (isLoadingMembers) {
              <div class="loading-members">
                <i class="fas fa-spinner fa-spin"></i>
                <span>ƒêang t·∫£i...</span>
              </div>
            } @else if (groupMembers.length > 0) {
              @for (member of groupMembers; track member.id) {
                <div class="member-item">
                  <img 
                    [src]="member.avatarUrl || 'assets/default-avatar.svg'" 
                    (error)="onAvatarError($event)"
                    class="member-avatar"
                    [alt]="member.username">
                  <span class="member-name">
                    {{ member.username }}
                    @if (isCurrentUser(member.id)) {
                      <span class="you-badge">(B·∫°n)</span>
                    }
                  </span>
                  @if (!isCurrentUser(member.id)) {
                    <a 
                      class="member-profile-link" 
                      [routerLink]="['/profile', member.id]"
                      title="Xem h·ªì s∆°">
                      <i class="fas fa-external-link-alt"></i>
                    </a>
                  }
                </div>
              }
            } @else {
              <div class="no-members">
                <span>Kh√¥ng c√≥ th√¥ng tin th√†nh vi√™n</span>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Search in Chat Mode -->
    @if (isSearchMode) {
      <div class="search-in-chat">
        <div class="search-header">
          <button class="search-back-btn" (click)="closeSearchInChat()">
            <i class="fas fa-arrow-left"></i>
          </button>
          <input 
            type="text"
            [(ngModel)]="searchKeyword"
            (keyup.enter)="performSearch()"
            placeholder="T√¨m tin nh·∫Øn..."
            class="search-input"
            #searchInput>
          <button 
            class="search-submit-btn" 
            (click)="performSearch()"
            [disabled]="!searchKeyword.trim()">
            <i class="fas fa-search"></i>
          </button>
        </div>

        @if (isSearching) {
          <div class="search-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>ƒêang t√¨m ki·∫øm...</span>
          </div>
        }

        @if (searchResults.length > 0) {
          <div class="search-results">
            @for (result of searchResults; track result.id) {
              <div class="search-result-item" (click)="scrollToMessage(result)">
                <div class="result-content">{{ result.content | slice:0:80 }}{{ result.content.length > 80 ? '...' : '' }}</div>
                <div class="result-time">{{ result.timestamp | date:'dd/MM/yyyy HH:mm' }}</div>
              </div>
            }
          </div>
        }

        @if (!isSearching && searchKeyword.trim() && searchResults.length === 0 && hasSearched) {
          <div class="no-results">
            <i class="fas fa-search"></i>
            <span>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</span>
          </div>
        }
      </div>
    } @else {
      <!-- Media & Files Accordion -->
      <div class="sidebar-section">
        <button 
          class="section-header" 
          (click)="toggleMediaSection()"
          [attr.aria-expanded]="isMediaSectionOpen">
          <span>File ph∆∞∆°ng ti·ªán & File</span>
          <i class="fas" [class.fa-chevron-down]="!isMediaSectionOpen" [class.fa-chevron-up]="isMediaSectionOpen"></i>
        </button>

        @if (isMediaSectionOpen) {
          <div class="section-content">
            <!-- Tabs -->
            <div class="media-tabs">
              <button 
                class="media-tab" 
                [class.active]="activeMediaTab === 'media'"
                (click)="switchMediaTab('media')">
                ·∫¢nh/Video
              </button>
              <button 
                class="media-tab" 
                [class.active]="activeMediaTab === 'files'"
                (click)="switchMediaTab('files')">
                File
              </button>
            </div>

            <!-- Media Tab Content -->
            @if (activeMediaTab === 'media') {
              @if (isLoadingMedia) {
                <div class="loading-media">
                  <i class="fas fa-spinner fa-spin"></i>
                </div>
              } @else if (mediaItems.length > 0) {
                <div class="media-grid">
                  @for (item of mediaItems; track item.id) {
                    <div class="media-item" (click)="openLightbox(item)">
                      @if (item.type === 'IMAGE') {
                        <img [src]="item.content" [alt]="'Media'" loading="lazy">
                      } @else if (item.type === 'VIDEO') {
                        <div class="video-thumb">
                          <video [src]="item.content" preload="metadata"></video>
                          <i class="fas fa-play-circle"></i>
                        </div>
                      }
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-section">
                  <i class="fas fa-image"></i>
                  <span>Ch∆∞a c√≥ ·∫£nh/video</span>
                </div>
              }
            }

            <!-- Files Tab Content -->
            @if (activeMediaTab === 'files') {
              @if (isLoadingMedia) {
                <div class="loading-media">
                  <i class="fas fa-spinner fa-spin"></i>
                </div>
              } @else if (fileItems.length > 0) {
                <div class="files-list">
                  @for (file of fileItems; track file.id) {
                    <a [href]="file.content" target="_blank" class="file-item">
                      <div class="file-icon">
                        <i class="fas fa-file-alt"></i>
                      </div>
                      <div class="file-info">
                        <span class="file-name">{{ file.fileName || 'File' }}</span>
                        <span class="file-date">{{ file.timestamp | date:'dd/MM/yyyy' }}</span>
                      </div>
                      <button class="file-download">
                        <i class="fas fa-download"></i>
                      </button>
                    </a>
                  }
                </div>
              } @else {
                <div class="empty-section">
                  <i class="fas fa-file-alt"></i>
                  <span>Ch∆∞a c√≥ file</span>
                </div>
              }
            }
          </div>
        }
      </div>
    }
  }
</aside>

<!-- Lightbox for Image/Video Preview -->
@if (lightboxItem) {
  <div class="lightbox-overlay" (click)="closeLightbox()">
    <button class="lightbox-close" (click)="closeLightbox()">
      <i class="fas fa-times"></i>
    </button>
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      @if (lightboxItem.type === 'IMAGE') {
        <img [src]="lightboxItem.content" [alt]="'Preview'">
      } @else if (lightboxItem.type === 'VIDEO') {
        <video [src]="lightboxItem.content" controls autoplay></video>
      }
    </div>
  </div>
}