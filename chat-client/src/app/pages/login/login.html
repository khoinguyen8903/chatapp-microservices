<div class="login-wrapper">
  <div class="shape shape-1"></div>
  <div class="shape shape-2"></div>

  <div class="login-card">
    <div class="text-center mb-8">
      <div class="logo-container">
        <i class="fas fa-comments"></i>
      </div>
      <h2 class="title">
        {{ isLoginMode() ? 'Chào mừng trở lại' : 'Tạo tài khoản mới' }}
      </h2>
      <p class="subtitle">
        {{ isLoginMode() ? 'Đăng nhập để tiếp tục kết nối' : 'Tham gia cộng đồng chat miễn phí' }}
      </p>
    </div>

    <form [formGroup]="authForm" (ngSubmit)="onSubmit()" class="space-y-5">
      
      @if (!isLoginMode()) {
        <div class="space-y-4 animate-slide-in">
          <div class="form-group">
            <label>Họ và Tên</label>
            <div class="input-wrapper">
              <span class="icon"><i class="fas fa-id-card"></i></span>
              <input type="text" formControlName="fullName" placeholder="Ví dụ: Nguyễn Văn A" class="input-field"
                [class.border-red-500]="f['fullName'].invalid && f['fullName'].touched">
            </div>
            @if (f['fullName'].hasError('max') && f['fullName'].touched) {
              <small class="text-red-500 text-xs ml-1">Tên quá dài (max 50 ký tự)</small>
            }
          </div>

          <div class="form-group">
            <label>Email</label>
            <div class="input-wrapper">
              <span class="icon"><i class="fas fa-envelope"></i></span>
              <input type="email" formControlName="email" placeholder="name@company.com" class="input-field"
                [class.border-red-500]="f['email'].invalid && f['email'].touched">
            </div>
             @if (f['email'].invalid && f['email'].touched) {
              <small class="text-red-500 text-xs ml-1">Email không hợp lệ</small>
            }
          </div>
        </div>
      }

      <div class="form-group">
        <label>Tài khoản</label>
        <div class="input-wrapper">
          <span class="icon"><i class="fas fa-user"></i></span>
          <input type="text" formControlName="username" placeholder="Nhập username" class="input-field"
             [class.border-red-500]="f['username'].invalid && f['username'].touched">
        </div>
        
        @if (f['username'].touched && f['username'].invalid) {
          <div class="text-red-500 text-xs ml-1 flex flex-col mt-1">
            @if (f['username'].hasError('required')) { <span>Username không được để trống.</span> }
            @if (f['username'].hasError('minlength')) { <span>Tối thiểu 3 ký tự.</span> }
            @if (f['username'].hasError('maxlength')) { <span>Tối đa 20 ký tự.</span> }
            @if (f['username'].hasError('pattern')) { <span>Chỉ chứa chữ và số, không ký tự đặc biệt.</span> }
            @if (f['username'].hasError('serverError')) { <span>{{ f['username'].getError('serverError') }}</span> }
          </div>
        }
      </div>

      <div class="form-group">
        <label>Mật khẩu</label>
        <div class="input-wrapper">
          <span class="icon"><i class="fas fa-lock"></i></span>
          <input [type]="showPassword() ? 'text' : 'password'" formControlName="password" placeholder="••••••••" class="input-field pr-10"
             [class.border-red-500]="f['password'].invalid && f['password'].touched">
          
          <button type="button" (click)="togglePassword()" class="password-toggle" tabindex="-1">
            <i class="fas" [class]="showPassword() ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>

        @if (f['password'].touched && f['password'].invalid) {
          <div class="text-red-500 text-xs ml-1 mt-1">
            @if (f['password'].hasError('required')) { <span>Mật khẩu không được để trống.</span> }
            @if (f['password'].hasError('minlength')) { <span>Mật khẩu phải từ 6 ký tự trở lên.</span> }
            @if (f['password'].hasError('serverError')) { <span>{{ f['password'].getError('serverError') }}</span> }
          </div>
        }
      </div>

      @if (!isLoginMode()) {
        <div class="form-group animate-slide-in">
          <label>Xác nhận mật khẩu</label>
          <div class="input-wrapper">
            <span class="icon"><i class="fas fa-check-circle"></i></span>
            <input type="password" formControlName="confirmPassword" placeholder="••••••••" class="input-field"
               [class.border-red-500]="authForm.hasError('mismatch') || (f['confirmPassword'].invalid && f['confirmPassword'].touched)">
          </div>
           @if (f['confirmPassword'].touched && f['confirmPassword'].hasError('mismatch')) {
              <small class="text-red-500 text-xs ml-1">Mật khẩu xác nhận không khớp.</small>
           }
        </div>
      }

      @if (verificationMessage()) {
        <div class="success-alert animate-slide-in">
          <i class="fas fa-check-circle"></i>
          <span>{{ verificationMessage() }}</span>
        </div>
      }

      @if (globalError()) {
        <div class="error-alert animate-shake">
          <i class="fas fa-exclamation-triangle"></i>
          <span>{{ globalError() }}</span>
        </div>
      }

      <button type="submit" [disabled]="isLoading()" class="submit-btn">
        @if (isLoading()) {
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Đang xử lý...</span>
        } @else {
          <span>{{ isLoginMode() ? 'ĐĂNG NHẬP' : 'ĐĂNG KÝ NGAY' }}</span>
          <i class="fas fa-arrow-right ml-1"></i>
        }
      </button>
    </form>
    <div class="footer">
      {{ isLoginMode() ? 'Chưa có tài khoản?' : 'Đã có tài khoản?' }}
      <button (click)="toggleMode()" class="toggle-link">
        {{ isLoginMode() ? 'Đăng ký miễn phí' : 'Đăng nhập ngay' }}
      </button>
    </div>
  </div>
</div>